{% extends "core/layout.html" %}
{% load static %}

{% block head %}
<script src="{% static 'js/feed.js' %}"></script>
{% endblock head %}

{% block content %}

<!-- Video Feed View -->
<div
        x-data="videoFeed()"
        x-init="init()"
        class="min-h-screen bg-black text-white"
>
    <!-- Feed container: vertically snapping -->
    <div
            id="feed"
            class="h-screen overflow-y-auto snap-y snap-mandatory"
            @scroll.window.debounce="onScroll"
    >
        <!-- Video items -->
        <template x-for="(video, index) in videos" :key="video.id">
            <div
                    class="video-container relative h-screen snap-start flex items-center justify-center bg-black"
            >
                <!-- video element -->
                <video
                        x-ref="video"
                        :data-index="index"
                        :id="`video-${video.id}`"
                        class="w-full h-full object-cover"
                        playsinline
                        muted
                        loop
                        preload="metadata"
                        @timeupdate="updateProgress(index, $event)"
                        @loadeddata="onVideoLoaded(index)"
                >
                    <source :src="video.src" type="video/mp4"/>
                    Your browser does not support the video tag.
                </video>

                <!-- spinner loader while video buffering -->
                <div
                        x-show="loadingVideo[index]"
                        class="absolute inset-0 flex items-center justify-center bg-black/60"
                >
                    <div class="animate-spin rounded-full border-4 border-t-4 border-gray-300 w-12 h-12"></div>
                </div>

                <!-- Overlay -->
                <div class="video-overlay absolute inset-0 flex flex-col justify-between p-4 pointer-events-none">
                    <!-- Top bar -->
                    <div class="flex justify-between items-center pointer-events-auto">
                        <div class="text-2xl font-['Pacifico']">MyApp</div>
                    </div>

                    <!-- Right action bar -->
                    <div class="action-bar absolute right-4 bottom-24 flex flex-col items-center gap-6 pointer-events-auto">
                        <!-- Like -->
                        <button
                                @click="toggleLike(video, index)"
                                class="w-12 h-12 flex flex-col items-center justify-center"
                                :class="{'text-red-500': video.liked}"
                                aria-label="Like"
                        >
                            <i x-html="video.liked ? '&#9829;' : '&#9825;'" class="text-2xl"></i>
                            <span class="text-xs mt-1" x-text="formatCount(video.likes)"></span>
                        </button>

                        <!-- Comment -->
                        <button
                                @click="openComments(video)"
                                class="w-12 h-12 flex flex-col items-center justify-center"
                                aria-label="Comments"
                        >
                            <i class="ri-chat-1-line ri-2x"></i>
                            <span class="text-xs mt-1" x-text="formatCount(video.comments_count)"></span>
                        </button>

                        <!-- Share -->
                        <button
                                @click="shareVideo(video)"
                                class="w-12 h-12 flex flex-col items-center justify-center"
                                aria-label="Share"
                        >
                            <i class="ri-share-forward-line ri-2x"></i>
                            <span class="text-xs mt-1">Share</span>
                        </button>

                        <!-- User avatar -->
                        <button @click="openProfile(video.user)" class="w-12 h-12 flex items-center justify-center">
                            <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-white/30">
                                <img :src="video.user.avatar" alt="User" class="w-full h-full object-cover"/>
                            </div>
                        </button>
                    </div>

                    <!-- Bottom info -->
                    <div class="flex flex-col gap-2 mb-2 pointer-events-auto">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold" x-text="`@${video.user.username}`"></span>
                            <button class="bg-primary text-white text-xs px-2 py-0.5 rounded-full">Follow</button>
                        </div>
                        <p class="text-sm" x-text="video.description"></p>
                    </div>
                </div>

                <!-- Bottom progress bar for this video -->
                <div class="absolute bottom-0 left-0 w-full h-1 bg-gray-700">
                    <div
                            class="h-full bg-primary"
                            :style="`width: ${progress[index] ?? 0}%`"
                    ></div>
                </div>
            </div>
        </template>

        <!-- skeleton loader cards while loading more -->
        <template x-if="loadingMore">
            <div class="space-y-4 p-6">
                <div class="h-96 bg-gray-800 animate-pulse rounded"></div>
                <div class="h-96 bg-gray-800 animate-pulse rounded"></div>
            </div>
        </template>

        <!-- final empty state -->
        <div x-show="!hasMore && !videos.length" class="p-8 text-center text-gray-400">
            No videos to show.
        </div>
    </div>

    {% include "comments.html" %}
</div>
{% endblock content %}